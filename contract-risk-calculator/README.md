# Bitget 合约下单金额计算器

一个纯前端（HTML/CSS/JS）的风险控制计算器，用于 Bitget USDT 永续场景下按**固定亏损金额**反推**下单金额（USDT）**。

## 功能概览

- 固定杠杆：`150x`（只读，不可修改）
- 支持最多 2 个入场价（分批建仓）+ 1 个止损价
- Entry2 可空：不填时自动按单腿 `100/0`
- 自动识别多/空方向
- 支持单一止盈、最多 3 级分批止盈
- 计算中纳入手续费（开仓+平仓）
- 下单按 USDT 口径计算（结果展示以两腿保证金为主）
- `qtyStep/minQty` 已隐藏，改为交易对预设：`USDT步进 1`、`最小下单 5`
- 本地历史记录（最近 20 条，可回填；列表展示交易对/方向/两腿保证金）

## 项目结构

- `index.html`：页面结构
- `styles.css`：样式
- `app.js`：交互与渲染
- `core.js`：核心计算逻辑
- `core.test.js`：单元测试

## 快速使用

1. 打开 `/Users/luz/Desktop/Dev/Projects/contract-risk-calculator/index.html`
2. 填写：入场价、止损价、固定亏损金额、手续费
3. 选择止盈模式并填写止盈参数
4. 点击“开始计算”查看两腿保证金、止损成本与止盈结果

> 也可以在目录下启动本地静态服务后访问页面。

## 公开分享（Netlify Drop）

这是纯静态项目，最省事的公开方式是 Netlify Drop：

1. 打开 [Netlify Drop](https://app.netlify.com/drop)
2. 上传本目录下的 `share/contract-risk-calculator-netlify-drop.zip`
3. 等待完成后获取 `https://xxx.netlify.app` 链接并分享

### 持续更新建议

1. 先登录 Netlify 并 Claim 站点
2. 修改站点名称为更易记的地址
3. 后续更新可继续 Drop 覆盖，或接入 GitHub 自动部署

### 分享时建议附带说明

- 本工具为理论计算器，不连接交易所 API
- 计算基于固定 150x 与当前页面参数口径
- 历史记录保存在用户浏览器本地，不会同步到服务器

## 输入说明

- `Entry1 价格`：必填
- `Entry2 价格`：可选，空即单腿模式
- `Entry1 占比%`：仅双腿时生效（按 **USDT金额** 占比，Entry2 自动为 `100 - Entry1`）
- `Entry2 占比%（自动）`：仅在输入框内显示自动值，不再单独显示下方百分比文本
- `止损价`：必填
- `固定亏损金额`：每单最大可接受亏损（USDT），默认 `300`
- `手续费率%`：默认 `0.04`

## 主要计算规则

1. 用加权入场均价与止损判断方向：
   - `stop < avgEntry` => Long
   - `stop > avgEntry` => Short
2. 每腿单位风险（每 1 币）= 价格风险 + 手续费（开仓+止损平仓）
3. 将单位风险换算成“每 1 USDT 名义金额的风险”并反推总下单金额
4. 总下单金额按 USDT 步进向下取整，并校验最小下单金额
5. 双腿按 USDT 占比拆分金额，内部再换算币数量用于风险/止盈计算
6. 初始保证金 = 下单金额 / `150`
7. 止盈采用加权均价近似计算（单 TP 和多 TP）

## 多级止盈规则

- 最多 3 级
- 每级填写：`TP 价格 + 平仓比例`
- 比例总和必须等于 `100%`
- 结果表展示：级别、价格、比例、手续费、盈亏、RR

## 结果说明

- 方向（LONG/SHORT）
- 腿1保证金、腿2保证金（USDT，定义为该腿名义金额 / 150）
- 手续费估算（开仓+平仓）
- 实际止损金额
- 止损价
- 止盈预估（单 TP / 多 TP）与 RR（多级模式不展示“平仓金额”列）

## 参数示例（可直接照填）

> 下方结果是按当前公式计算的示例值，实际会随手续费变化。  
> 注意：示例为了便于对比，沿用 `固定亏损=50 USDT`、`手续费=0.05%`，不代表当前页面默认值。

### 示例 A：单腿建仓（BTCUSDT）

输入：

- `Entry1=100000`
- `Entry2=空`
- `止损=98500`
- `固定亏损=50 USDT`
- `手续费=0.05%`
- 单一止盈：`TP=102000`

参考输出（约）：

- 方向：`LONG`
- 腿1保证金：`20.8400 USDT`
- 腿2保证金：`0.0000 USDT`
- 实际止损：`49.9926 USDT`
- 止盈盈亏：`59.3627 USDT`
- RR（按目标风险）：`1.1873R`

### 示例 B：双腿分批建仓（BTCUSDT）

输入：

- `Entry1=100000`
- `Entry2=99500`
- `Entry1占比=60%`（Entry2 自动 `40%`）
- `止损=98500`
- `固定亏损=50 USDT`
- `手续费=0.05%`
- 多级止盈：
  - `TP1=101500`，`40%`
  - `TP2=102500`，`30%`
  - `TP3=103500`，`30%`

参考输出（约）：

- 方向：`LONG`
- 腿1保证金：`14.2667 USDT`
- 腿2保证金：`9.5133 USDT`
- 实际止损：`49.9855 USDT`
- 多级止盈总盈亏：`89.3545 USDT`
- 总RR（按目标风险）：`1.7871R`

## 重要提醒

- 本工具是**理论计算器**，不直接连接交易所接口
- 结果按固定 `150x` 计算；请以 Bitget 实际可用杠杆与交易规则为准
- 当前按 USDT 口径步进，不直接等同交易所币数量最小单位

## 测试

在目录 `/Users/luz/Desktop/Dev/Projects/contract-risk-calculator` 下运行：

```bash
node --test core.test.js
```

当前测试覆盖：

- 单腿/双腿 USDT 下单金额计算
- 成本项影响（手续费）
- 最小下单金额约束
- 单止盈/多止盈
- 多级比例总和校验
- 方向与输入合法性校验
- 步进向下取整
